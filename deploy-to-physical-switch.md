# Installing and Booting OpenSwitch

- [Introduction](#introduction)
- [OpenSwitch Installer Architecture](#openswitch-installer-architecture)
	- [Image Partitions](#image-partitions)
	- [Configuration Partition](#configuration-partition)
- [Installing](#Installing)
	- [Installing using ONIE provisioning mechanisms](#installing-using-onie-provisioning-mechanisms)
	- [Installing manually from ONIE](#installing-manually-from-onie)
	- [Updating an existing installed OpenSwitch image](#updating-an-existing-installed-openswitch-image)

## Introduction

OpenSwitch is designed to work on [ONIE](http://onie.opencompute.org) based white-box switches.
The build system from OpenSwitch produces ONIE installer images, and you can check the [hardware compatibility lists](http://www.openswitch.net/documents/user/hardware-compatibility) to find if your hardware is supported.

You can get an image by building it yourself or downloading a pre-built one from the [download section](http://www.openswitch.net/use/usehome#downloads).

## OpenSwitch Installer Architecture
The ONIE specification leaves it up to the NOS to define the layout of the partitions.
OpenSwitch uses three partitions on ONIE-based hardware: two partitions are for dual OpenSwitch installation and one partition for persistent configuration. The size of the partitions is defined by the target platform.

```ditaa
+--------------------+
|                    |  Configuration partition:
|  OpenSwitch Conf   |  Preserved across installations
|                    |
+--------------------+
|                    |
|  OpenSwitch 1      |  Primary Image Partition
|                    |
+--------------------+
|                    |
|  OpenSwitch 2      |  Secondary Image Partition
|                    |
+--------------------+
```

### Image Partitions
The two image partitions are used for dual-image boot purposes. During the initial installation
the NOS is deployed to the first partition, and in subsequent updates or installations the new
image will be installed on the _inactive_ partition.

**NOTE**: OpenSwitch currently does not implement automatic rollback in case a newly-installed image fails to boot.

### Configuration Partition
The configuration partition stores the permanent configuration of the switch and will be preserved across image installations. It also stores the grubenv file that notifies the
installed grub about which is the _active_ image partition.

## Installing
There are several ways to install OpenSwitch (described below).

### Installing using ONIE provisioning mechanisms
Since the images generated by OpenSwitch are ONIE-compatible installers, you can follow
[ONIE Quick Start Guide](https://github.com/opencomputeproject/onie/wiki/Quick-Start-Guide) to identify a provisioning mechanism that suits your needs.

### Installing manually from ONIE
Follow these steps:

1. Boot your Switch into **ONIE Rescue OS** mode.
2. Copy the OpenSwitch ONIE installer file to your TFTP directory.
4. Enter the following commands:
```bash
tftp -g -r <onie-installer-file> -l <onie-installer-file> <tftp-server>
chmod +x <onie-installer-file>
./<onie-file> # will reboot automatically
```

If there was a previously installed version of OpenSwitch, the installer will identify
the _inactive_ partition and will install there (preserving the configuration partition).
If you want to perform a clean installation that removes the configuration partition and
installs on the first image partition, you can set the variable OPS_CLEAN_INSTALL to **true**
before invoking the installer. For example:
```bash
export OPS_CLEAN_INSTALL=true
./<onie-installer-file>
```

### Updating an existing installed OpenSwitch image
Since OpenSwitch uses a dual image partition you can copy the <onie-installer-file> to the
file system inside a running OpenSwitch installation and run the following commands to install
a new image on the _inactive_ partition:
```bash
chmod +x <onie-installer-file>
./<onie-installer-file>
```

In this scenario the switch won't reboot automatically and you have to reboot manually. Clean installation
is not possible from inside a running OpenSwitch image, and you will have to reboot into ONIE mode to
perform it if required. If you want to reboot into ONIE installation mode, the OpenSwitch Linux shell offers a command that
will trigger a reboot into ONIE install mode:
```bash
systemctl isolate onie-install
```
