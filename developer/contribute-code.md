# How to contribute to the code

Follow the [Getting Started](./getting-started.html) guide to prepare your system to be able to contribute to the OpenSwitch project.

## Contents

- [Contributing changes to OpenSwitch](#contributing-changes-to-openswitch)
	- [Preparing changes to be reviewed](#preparing-changes-to-be-reviewed)
	- [Sending changes for review](#sending-changes-for-review)
	- [Resubmitting a set of changes](#resubmitting-a-set-of-changes)
	- [After changes have been approved by Reviewers](#after-changes-have-been-approved-by-reviewers)
- [OpenSwitch Coding Style](#openswitch-coding-style)
	- [Comparisons](#comparisons)
	- [Variables](#variables)
- [How to add new code](#how-to-add-new-code)
	- [Adding a New Repository](#adding-a-new-repository)
		- [Writing a new daemon with CMake](#writing-a-new-daemon-with-cmake)
		- [Adding a recipe for your daemon](#adding-a-recipe-for-your-daemon)



## Contributing changes to OpenSwitch
Changes to the OpenSwitch code base go through a review process before being merged. This page describes how local modifications can be submitted for review and, if approved, made available upstream in the OpenSwitch project.

### Preparing changes to be reviewed
Before attempting to commit changes, make sure that they are compliant with the [OpenSwitch Coding Style](#openswitch-coding-style). For non-OpenSwitch modules, follow the coding style that the module already uses.

In particular,  the following files be rejected:
* Files with trailing spaces
* Files with with non-printable ASCII characters in their names.

Changes for review should be **committed to a local branch** with a commit message that:
* Begin with a single line of text which summarizes the contents of the change.
* Additionally provide a description following the summarization line.

If the change set has been composed by multiple commits to the local branch, **consider squashing them into a single commit** using `git rebase`.

### Sending changes for review
`git-review` is used as an aid when submitting a change set for review.
The commit message for the set of changes must include a `Change-Id`, as generated by the `-i` option to `git-review`. To send changes for review, commit the changes and then run git-review as follows:
```bash
$ git commit -s -m "Meaningful summary of this change set."
$ git-review -i
```
The `git-review` command output includes an URL for the change review. In example below the URL generated was: https://review.openswitch.net/1148.
```bash
$ git review
remote: Resolving deltas: 100% (1/1)
remote: Processing changes: new: 1, refs: 1, done
remote: (W) 5421c73: commit subject >65 characters; use shorter first paragraph
remote:
remote: New Changes:
remote:   https://review.openswitch.net/1148
```
Use the URL in the `git-review`output to login to the Review Site and add the list of reviewers.

### Resubmitting a set of changes
Reviewers may request modifications to the set of changes previously submitted. Make the changes as requested by the reviewers and then submit a patch with the following commands. The `-i` switch for `git-review` is not needed as a `Change-Id` was previously generated by the initial commit.
```bash
$ git commit --amend
$ git-review
```

It is also possible to abandon a set of changes using the web interface, if that is desired.

### After changes have been approved by Reviewers
* Log in to the change review URL using the link provided by the `git-review` command output.
* Click on the `Review` button and give the change a `+1 Approved` rate in the `Workflow` section.
* This initiates the process of merging your change with the main product documentation.

## OpenSwitch Coding Style
The coding style used for OpenSwitch is an extension of the [Open vSwitch Coding Style](https://github.com/openvswitch/ovs/blob/master/CodingStyle.md), which is itself an extension of the [One True Brace Style](https://en.wikipedia.org/wiki/Indent_style#Variant:_1TBS) for indenting. The additions below are clarifications and do not conflict with the Open vSwitch style.

### Comparisons
Write comparisons in a form that reads naturally. Examples:
```c
 bool foo_b = some_bool_function(x);
int foo_i = some_int_function(x);

if (true == foo_b)   /* No, unnecessary comparison and doesn't read well */
if (foo_b)           /* Yes */

if (11 == foo_i)     /* No, doesn't read well */
if (foo_i == 11)     /* Yes */

if (foo_i == 0)      /* Yes */
if (!foo_i)          /* Yes */
```

### Variables
Do not do gratuitous initialization of variables.  Doing this prevents the compiler from detecting accidental use before initialization.

```c
struct Goofus *goofus = NULL;   /* Wrong */
struct Gallant *gallant;        /* Right */
```

## How to add new code
OpenSwitch preferred build system for C/C++ applications is `CMake`.

### Adding a New Repository
The following are the steps to follow in order to add a new repo to the OpenSwitch project, referred as `<repo-name>`.

1) Git clone project:
```bash
git clone https://review.openswitch.net/infra/project-config
```

2) Create a new file `gerrit/acls/openswitch/ops-<repo-name>.config` with following contents.

**Note:** The code review and abandon group name should be `<repo-name>`-maintainers, as shown in this example:

```bash
[access "refs/heads/*"]
abandon = group Change Owner
abandon = group ops-<repo-name>-maintainers
label-Code-Review = -2..+2 group ops-<repo-name>-maintainers
label-Workflow = -1..+1 group Change Owner
```

3) The `ops-<repo-name>-maintainers` group for your repo will get created by the `project-config-maintainers` when they approve the code review.

4) Modify `gerrit/projects.yaml` to add the repository.
```html4strict
- project: openswitch/<repo-name>
  description: <Repo Description>
```

5) Git commit the changes.

**Note:** In the commit message please specify the full name for two users in `Git Hub` that you wish to add as maintainers of this repo.
```bash
git commit --signoff
```

6) Git review the changes
```bash
git review
 ```

#### Writing a new daemon with CMake

The new repo needs a CMake file to be able to index with the rest of the OpenSwitch project.
The easiest way to create a CMake file is to take a similar repo, copy the CMake and adapt it for the new repo.
The following is an example code taken from vland.

```bash
# Copyright (C) 2015 Hewlett-Packard Development Company, L.P.
# All Rights Reserved.
#
#    Licensed under the Apache License, Version 2.0 (the "License"); you may
#    not use this file except in compliance with the License. You may obtain
#    a copy of the License at
#
#         http://www.apache.org/licenses/LICENSE-2.0
#
#    Unless required by applicable law or agreed to in writing, software
#    distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#    License for the specific language governing permissions and limitations
#    under the License.

cmake_minimum_required (VERSION 2.8)

set (VLAND vland)
project (${VLAND})
set (SRC_DIR src)
set (INCL_DIR include)

# Rules to locate needed libraries
include(FindPkgConfig)
pkg_check_modules(OVSCOMMON REQUIRED libovscommon)
pkg_check_modules(OVSDB REQUIRED libovsdb)

include_directories (${PROJECT_BINARY_DIR} ${PROJECT_SOURCE_DIR}/${INCL_DIR}
                     ${OVSCOMMON_INCLUDE_DIRS}
)

# Define compile flags
set (CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -std=gnu99 -Wall -Werror")

# Source files to build vland
set (SOURCES ${SRC_DIR}/vland.c ${SRC_DIR}/vland_ovsdb_if.c)

# Rules to build vland
add_executable (${VLAND} ${SOURCES})

target_link_libraries (${VLAND} ${OVSCOMMON_LIBRARIES} ${OVSDB_LIBRARIES}
                       -lpthread -lrt)

# Rules to install vland binary in rootfs
install(TARGETS ${VLAND}
        RUNTIME DESTINATION bin)

```

For more details of how CMake works, please go to [CMake documentation](http://www.cmake.org/documentation/).

####  Adding a recipe for your daemon
It has to be a recipe for your deamon to work properly. This recipe should be placed in the `ops-build` repo, inside `yocto/openswitch/meta-distro-openswitch`.

There are different directories for the recipes:

- recipes-asic
- recipes-core
- recipes-kernel
- recipes-networking
- recipes-onie
- recipes-ops

Choose the directory that applies and add the `.bb` file in there.

This is an example of a recipe

``` bash
SUMMARY = "Management Interface Configuration Daemon"
LICENSE = "Apache-2.0"

LIC_FILES_CHKSUM = "file://${COMMON_LICENSE_DIR}/Apache-2.0;md5=89aea4e17d99a7cacdbeed46a0096b10"

DEPENDS = "ops-utils ops-ovsdb"

RDEPENDS_${PN} = "python-argparse python-json python-ops-ovsdb python-distribute"

SRC_URI = "git://git.openswitch.net/openswitch/ops-mgmt-intf;protocol=http \
           file://mgmt-intf.service \
         "

SRCREV="${AUTOREV}"

# When using AUTOREV, we need to force the package version to the revision of git
# in order to avoid stale shared states.
PV = "git${SRCPV}"

S = "${WORKDIR}/git"

do_install_prepend() {
     install -d ${D}${systemd_unitdir}/system
     install -m 0644 ${WORKDIR}/mgmt-intf.service ${D}${systemd_unitdir}/system/
}

SYSTEMD_PACKAGES = "${PN}"
SYSTEMD_SERVICE_${PN} = "mgmt-intf.service"

inherit openswitch setuptools systemd
```

The recipes have some important parts:

* **SUMMARY** = It is just a summary of your recipe.
* **LICENSE** = It is the license for your recipe.
* **LIC_FILES_CHKSUM** = It is the path of the license file with the md5.
* **DEPENDS** = In this label we have to include all the dependency that our recipe have in order to compile in this case is depending on `halonutils` and `halon--ovsdb`
* **SRC_URI** = This is the list of source files, it can be local or remote, Yocto supports several
 protocols. You can find the complete list in the [Yocto Ref Manual](http://www.yoctoproject.org/docs/current/ref-manual/ref-manual.html)
* **S** = This is the location in the build directory where the recipe source code resides. It is the work directory.
* **inherit** = You can use this variable to inherit the functionality of a class, in our case we need `cmake` in order to build this recipe.

If you need more details of how the BitBake works, please go to [BitBake documentation](https://www.yoctoproject.org/tools-resources/projects/bitbake).
